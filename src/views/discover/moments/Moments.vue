// ÊúãÂèãÂúà
<template>
  <div class="_full-container" @touchstart="touchstartAction">
    <div class="_full-content" id="ko">
      <!-- ÂØºËà™Ê†è -->
      <!-- <NavigationBar
        title="ÊúãÂèãÂúà"
        :left-item="backItem"
        :right-item="cameraItem"
        @left-click="$router.back()"
        @right-click="cameraItemDidClick"
        style="background-color:rgba(237, 237, 237, 0)"
      ></NavigationBar> -->
      <!-- ËÉåÊôØÈ°µ -->
      <!-- refreBall -->
      <div
        class="moment__refresh"
        :style="refreshStyle"
        :class="{ kkk: topStatus === 'loading' }"
      ></div>
      <!-- ÁÖßÁõ∏Êú∫ -->
      <img
        class="moment__camera"
        src="@/assets/images/moments/wx_moments_camera_face.png"
        alt=""
        @click="cameraItemDidClick"
      />
      <!-- ÂçïÊù°ËØ¥ËØ¥ -->
      <div
        class="moment__wrapper"
        id="drag"
        @touchstart="startDrag"
        @touchmove="onDrag"
        @touchend="stopDrag"
        @touchcancel="stopDrag"
        @scroll.passive="onScroll($event)"
      >
        <div class="moment__background"></div>
        <div
          id="drag-inner"
          :style="transform"
          :class="{ moment__dropped: topDropped || bottomDropped }"
        >
          <MomentProfile
            class="moment__profile"
            @cover-click="coverDidClick"
          ></MomentProfile>
          <div
            class="mh-moment"
            v-for="(moment, index) in moments"
            :key="index"
          >
            <!-- Â§¥ÈÉ® -->
            <div class="mh-moment__hd">
              <!-- Â§¥ÂÉè -->
              <img
                :src="moment.user.profile_image_url"
                alt
                @click="skipToContactInfo(moment)"
                @touchstart="avatarTouchStart(moment, $event)"
                @touchmove="avatarTouchMove"
                @touchend="avatarTouchEnd(moment)"
                @touchcancel="avatarTouchEnd(moment)"
              />
            </div>
            <!-- Ë∫´‰Ωì -->
            <div class="mh-moment__bd">
              <div class="mh-moment__name">
                <span
                  class="mh-moment--tap-highlight"
                  @click="skipToContactInfo(moment)"
                  >{{ moment.user.screen_name }}</span
                >
              </div>
              <!-- Ê≠£Êñá -->
              <!-- üî• ËøôÈáåÂøÖÈ°ªÂæóÁî® v-show Âõ†‰∏∫Êàë‰ª¨ËÆæÁΩÆ‰∫Ü refÔºåÂøÖÈ°ªÁöÑÊ∏≤ÊüìÂá∫Êù• ÔºåÂê¶Âàô‰ºöÂØºËá¥ this.$refs.content.length‰∏çÂØπ -->
              <div
                class="moment__content-wrapper"
                v-show="moment.text && moment.text.length > 0"
              >
                <p
                  class="mh-moment__content"
                  :class="moment.unfold ? 'unfold' : 'fold'"
                  ref="content"
                  v-html="moment.textHtml"
                  @click="contentDidClick(index, $event)"
                >
                  <!-- {{ moment.text || "" }} -->
                </p>
                <p class="mh-moment__expand" v-if="moment.showUnfold">
                  <span
                    class="mh-moment--tap-highlight"
                    @click="moment.unfold = !moment.unfold"
                    >{{ moment.unfold ? "Êî∂Ëµ∑" : "ÂÖ®Êñá" }}</span
                  >
                </p>
              </div>

              <!-- ÂõæÁâá‰πùÂÆ´Ê†º type === 0 -->
              <div
                class="mh-moment__pictures"
                :style="moment.picsWrapperStyle"
                v-if="
                  moment.pic_infos.length > 0 &&
                    (moment.type === undefined || moment.type === 0)
                "
              >
                <div
                  class="mh-moment__pic"
                  v-for="(pic, idx) in moment.pic_infos"
                  :key="idx"
                  :style="pic.picStyle"
                ></div>
              </div>
              <!-- ËßÜÈ¢ë type === 1 -->
              <div class="moment__video-wrapper" v-if="moment.type === 1">
                <div class="video-wrapper__play"></div>
              </div>
              <!-- ÂàÜ‰∫´ type === 2 -->
              <div class="moment__share-wrapper" v-if="moment.type === 2">
                <!-- shareInfoType === 0ÁΩëÈ°µ -->
                <div
                  class="share-wrapper__content"
                  v-if="moment.shareInfo.shareInfoType === 0"
                >
                  <div class="content__share-hd">
                    <img :src="moment.shareInfo.thumbImage" alt="" />
                  </div>
                  <div class="content__share-bd">
                    {{ moment.shareInfo.title }}
                  </div>
                </div>
                <!-- shareInfoType === 0Èü≥‰πê -->
                <div
                  class="share-wrapper__content"
                  v-if="moment.shareInfo.shareInfoType === 1"
                >
                  <div class="content__share-hd">
                    <img :src="moment.shareInfo.thumbImage" alt="" />
                    <div class="content__play"></div>
                  </div>
                  <div class="content__share-bd">
                    <p class="content__title">
                      {{ moment.shareInfo.title }}
                    </p>
                    <p class="content__subtitle">
                      {{ moment.shareInfo.descr }}
                    </p>
                  </div>
                </div>
              </div>
              <!-- Âú∞ÁêÜ‰ΩçÁΩÆ -->
              <div
                class="moment__location-wrapper"
                v-if="moment.location && moment.location.length > 0"
              >
                <span class="mh-moment--tap-highlight">{{
                  moment.location
                }}</span>
              </div>

              <!-- Êó∂Èó¥/Êù•Ê∫ê/Êõ¥Â§ö -->
              <div class="mh-moment__more-wrapper">
                <p class="mh-moment__time">
                  {{ moment.created_at | dateFormat }}
                </p>
                <transition name="fade">
                  <!-- $event ÂΩìÂú®Áà∂Á∫ßÁªÑ‰ª∂ÁõëÂê¨Ëøô‰∏™‰∫ã‰ª∂ÁöÑÊó∂ÂÄôÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøá $event ËÆøÈóÆÂà∞Ë¢´ÊäõÂá∫ÁöÑËøô‰∏™ÂÄº -->
                  <MomentOperationMore
                    class="more-wrapper__operation"
                    v-if="moment.showCmt"
                    :thumbed="moment.attitudes_status"
                    @thumb-click="thumbAction(moment, $event)"
                    @comment-click="commentAction(moment)"
                  ></MomentOperationMore>
                </transition>
                <div
                  class="mh-moment__more"
                  @click.stop="moreBtnAction(moment)"
                  @touchstart.stop
                ></div>
              </div>

              <!-- ÁÇπËµûorËØÑËÆ∫ ÂàóË°® -->
              <div
                class="moment__comment-wrapper"
                v-if="
                  moment.attitudes_list.length > 0 ||
                    moment.comments_list.length > 0
                "
              >
                <!-- ÁÇπËµûÂàóË°® -->
                <div
                  class="comment-wrapper__attitudes"
                  v-html="moment.attitudesHtml"
                  @click="attitudesItemDidClick(index, $event)"
                  v-if="moment.attitudes_list.length > 0"
                ></div>
                <!-- ËØÑËÆ∫ÂàóË°® -->
                <div
                  class="comment-wrapper__comments"
                  v-if="moment.comments_list.length > 0"
                >
                  <!-- ËøôÈáå‰∫ã‰ª∂Êää index idx ÈÉΩ‰º†Âá∫Âéª -->
                  <div
                    class="comment-wrapper__comment"
                    v-for="(cmt, idx) in moment.comments_list"
                    :key="idx"
                    v-html="cmt.commentHtml"
                    @click="commentItemDidClick(index, idx, $event)"
                  ></div>
                </div>
                <!-- ÂàÜÂâ≤Á∫ø -->
                <div class="comment-wrapper__line"></div>
              </div>
            </div>
          </div>
          <!-- ‰∏äÊãâÂä†ËΩΩÂà∑Êñ∞Êéß‰ª∂ -->
          <div class="weui-loadmore" ref="loadMore">
            <i class="weui-loading"></i>
            <span class="weui-loadmore__tips">&nbsp;Ê≠£Âú®Âä†ËΩΩ...</span>
          </div>
        </div>
      </div>

      <!-- ActionSheet -->
      <actionSheet
        v-model="showActionSheet"
        @did-click-item="didClickItem"
        :items="items"
      ></actionSheet>
    </div>
  </div>
</template>

<script>
import { cameraItem } from "assets/js/MHBarButtonItem.js";
import actionSheet, {
  ActionSheetItem
} from "components/actionSheet/ActionSheet";
import MHMoments from "../../../assets/js/MHMoments.js";
import MHMoments2 from "../../../assets/js/MHMoments2.js";
import MHMoments3 from "../../../assets/js/MHMoments3.js";
import MHMoments4 from "../../../assets/js/MHMoments4.js";
import MomentOperationMore from "./view/MomentOperationMore";
import MomentProfile from "./view/MomentProfile";
import { mapState } from "vuex";
// Â∑•ÂÖ∑Á±ª
import utils from "../../../assets/utils/utils.js";
// helper
import helper from "./js/momentsHelper.js";
export default {
  name: "moments",
  data() {
    return {
      cameraItem: cameraItem,

      moments: [],
      // actionSheet ÁöÑÊï∞ÊçÆÊ∫ê
      items: [],
      // ÊòæÁ§∫ActionSheet
      showActionSheet: false,
      // actionSheetTitle
      actionSheetTitle: "",
      // Êõ¥Â§öitems
      cameraItems: [],
      showCamera: false,
      // delItems
      delItems: [],
      showDel: false,
      // coverItems
      coverItems: [],
      shwoCover: false,
      // ÁîµËØùÂè∑Á†Åitems
      showPhoneNumber: false,
      // ÈïøÊåâÂ§¥ÂÉèÁöÑitems
      showAvatar: false,
      attitudesIcon:
        "<img src=" +
        require("@/assets/images/moments/wx_albumInformationLikeHL_15x15.png") +
        " width='15' height='15'>",
      // ÂÖ®ÊñáÊàñÊî∂Ëµ∑
      expanded: false,

      // ÂΩìÂâçÊòæÁ§∫ÁöÑmoment
      tempMoment: {},
      // Ë¶ÅÂà†Èô§ÁöÑËØÑËÆ∫Êï∞ÊçÆÁöÑÁ¥¢Âºï {section , row}
      delCmtIndexPath: {},
      rotes: false,
      startY: "", //‰øùÂ≠òtouchÊó∂ÁöÑYÂùêÊ†á
      moveDistance: 0, //‰øùÂ≠òÂêë‰∏ãÊªëÂä®ÁöÑË∑ùÁ¶ª
      // ÂºÄÂßãÊªëÂä®Âà∞ÁªìÊùüÂêéÁä∂ÊÄÅÁöÑÂèòÂåñ 0:‰∏ãÊãâÂç≥ÂèØÂà∑Êñ∞ 1:ÈáäÊîæÂç≥ÂèØÂà∑Êñ∞ 2:Âä†ËΩΩ‰∏≠
      refreshState: 0,
      duration: 0, //Âä®ÁîªÊåÅÁª≠Êó∂Èó¥Ôºå0Â∞±ÊòØÊ≤°ÊúâÂä®Áîª
      // ‰∏ãÊãâÂà∑Êñ∞‰∏¥ÁïåÁÇπ
      topDistance: 40,
      // touchState Ëß¶Êë∏Áä∂ÊÄÅ(0 touchend ; 1 touchstart ; 2 touchend)
      touchSate: 0,
      // ÊúÄÂêé‰∏ÄÊ¨°topValue
      lastRefreshTop: 0,
      // startScrollTop
      startScrollTop: 0,

      // ÁßªÂä®ÊñπÂêë upÔºö‰∏äÊãâ downÔºö‰∏ãÊãâ
      direction: "",
      // ‰∏ãÊãâÂà∑Êñ∞Áä∂ÊÄÅ
      topStatus: "",
      topDropped: false,

      // ÊòØÂê¶Âà∞ËææÂ∫ïÈÉ®
      bottomReached: false,
      // Â∫ïÈÉ®Êéß‰ª∂Áä∂ÊÄÅ
      bottomStatus: "",
      // Â∫ïÈÉ®Êéß‰ª∂ÊòØÂê¶Â§Ñ‰∫é dropÁä∂ÊÄÅ
      bottomDropped: false,

      // tempSt
      tempStartScrollTop: 0,
      tempStartY: 0,
      currentY: 0,
      // page
      page: 1,
      // ÂÆöÊó∂Âô®
      timeOutEvent: 0
    };
  },
  destroyed() {
    console.log("++++++ ÊàëÂ∑≤Áâ∫Áâ≤ ++++++");
  },
  created() {
    console.log("++++++ ÈáçÊñ∞ÂàõÂª∫ ++++++");
    // ÈÖçÁΩÆaction-sheet item
    this.configActionSheetItems();
    // üî• Êï∞ÁªÑÊãºÊé•Âè¶‰∏Ä‰∏™Êï∞ÁªÑ
    // üëâ - [jsÊï∞ÁªÑÊãºÊé•ÁöÑÂõõÁßçÊñπÊ≥ï]https://blog.csdn.net/cristina_song/article/details/82805444
    let temps = this.handleWebDatas(MHMoments.moments);
    // üî• Â∞ΩÈáèÁî® push Êù•ÊãºÊé•Êï∞ÁªÑÔºåËÄå‰∏çÊòØconcat
    // üëâ - [Êï∞ÁªÑÊõ¥Êñ∞Ê£ÄÊµã](https://cn.vuejs.org/v2/guide/list.html)
    this.moments.push(...temps); // es6 ÂÜôÊ≥ï
  },
  mounted() {
    // Â§ÑÁêÜdomÊï∞ÊçÆ
    this.handleDomDatas(0);
    // ÂºÄÂßãÂà∑Êñ∞
    this.topStatus = "loading";
    // Ë∞ÉÁî®‰∏ÄÊ¨°ËØ∑Ê±ÇÊï∞ÊçÆ
    this.topMethod();
  },
  methods: {
    // Â§¥ÂÉèÈïøÊåâ/ÁÇπÂáª‰∫ã‰ª∂
    avatarTouchStart(m, e) {
      // ÈòªÊ≠¢ÊéâÈ°µÈù¢ÁöÑÈªòËÆ§‰∫ã‰ª∂
      e.preventDefault();
      let timeOutEvent = setTimeout(() => {
        this.timeOutEvent = 0;
        const permission = new ActionSheetItem({
          title: "ËÆæÁΩÆÊùÉÈôê"
        });
        const complain = new ActionSheetItem({
          title: "ÊäïËØâ"
        });
        this.items = [permission, complain];
        this.showActionSheet = true;
        this.showAvatar = true;
      }, 500);
      this.timeOutEvent = timeOutEvent;
    },
    avatarTouchMove() {
      clearTimeout(this.timeOutEvent);
      this.timeOutEvent = 0;
    },
    avatarTouchEnd(m) {
      clearTimeout(this.timeOutEvent);
      if (this.timeOutEvent !== 0) {
        // ÁÇπÂáª‰∫ã‰ª∂
        this.skipToContactInfo(m);
      }
      return false;
    },

    // https://blog.csdn.net/qq_34439125/article/details/85602508
    // https://www.jianshu.com/p/0fed94bb1239
    // https://www.cnblogs.com/qq120848369/p/6651096.html
    // https://www.cnblogs.com/winyh/p/6714923.html
    // https://www.cnblogs.com/fengfan/p/4506555.html
    // https://developer.mozilla.org/zh-CN/docs/Web/API/Touch_events
    // ÂºÄÂßãÊãñÊãΩ
    startDrag(e) {
      this.touchSate = 1;

      this.rotes = false;
      this.duration = 0; // ÂÖ≥Èó≠Âä®Áîª
      this.moveDistance = 0; // ÊªëÂä®Ë∑ùÁ¶ªÂΩí0
      let t = e.targetTouches[0]; // Ëé∑ÂæóÂºÄÂßãYÂùêÊ†á

      this.startY = t.clientY;
      let scrollTop = document.getElementById("drag").scrollTop;
      // ËÆ∞ÂΩï‰∏Ä‰∏ãËµ∑Âßã st
      this.startScrollTop = scrollTop;

      this.tempStartY = this.startY;
      this.tempStartScrollTop = scrollTop;

      this.bottomReached = false;

      if (this.topStatus !== "loading") {
        this.topStatus = "pull";
        this.topDropped = false;
      }
      if (this.bottomStatus !== "loading") {
        this.bottomStatus = "pull";
        this.bottomDropped = false;
      }
    },
    // Ê≠£Âú®ÊãñÊãΩ
    onDrag(e) {
      this.touchSate = 2;
      let scrollEventTarget = document.getElementById("drag");
      let scrollTop = scrollEventTarget.scrollTop;
      let currentY = e.targetTouches[0].clientY;
      let currentScrollTop = scrollEventTarget.scrollTop;

      // ÂÅèÁßªË∑ùÁ¶ª
      let distance = (currentY - this.startY) / 2;
      // ‰∏äÊãâor‰∏ãÊãâ
      this.direction = distance > 0 ? "down" : "up";

      // Âà§Êñ≠ÊòØÂê¶Âú®È°∂ÈÉ®‰∏îÂ§Ñ‰∫é‰∏ãÊãâÁä∂ÊÄÅ
      if (currentScrollTop === 0 && this.direction === "down") {
        // ÈòªÊ≠¢ÈªòËÆ§‰∫ã‰ª∂ÔºåÂú®ÂæÆ‰ø°ÊµèËßàÂô®‰∏≠Â∞§‰∏∫ÊúâÁî®ÔºåËá≥‰∫é‰∏∫‰ªÄ‰πàÔºå‰Ω†ÂéªËØïÂ∞±Áü•ÈÅì‰∫Ü„ÄÇ
        // ÁªÑÁªáÊéâ onscroll ÈªòËÆ§‰∫ã‰ª∂
        e.preventDefault();
        e.stopPropagation();
        // ÂÆπÈîôÂ§ÑÁêÜÔºö‰ªéÂ∑≤Áªè‰∏ãÊªë‰∏ÄÊÆµË∑ùÁ¶ªÂêë‰∏ãÊãñÊãΩÔºå‰ºöÂØºËá¥ move Ë∑ùÁ¶ªÂæàÂ§ßÔºåÂΩìÂà∞Ëææ‰∏¥ÁïåÁÇπÁöÑÊó∂ÂÄôÔºåÁ™ÅÁÑ∂Êéâ‰∏ãÊù• ÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
        if (this.startScrollTop !== 0 && currentScrollTop === 0) {
          this.startY = currentY;
          this.startScrollTop = 0;
          distance = 0;
        }
        // ‰∏çÁÆ°‰∏ãÊãâÂà∑Êñ∞Áä∂ÊÄÅÔºåËøô‰∏™distanceÈïøÊúüÊúâÊïà
        this.moveDistance = distance;
        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Âà∑Êñ∞
        if (this.topStatus !== "loading") {
          // Â¶ÇÊûúÂ§ß‰∫é‰∏¥ÁïåÁÇπÔºåÈáäÊîæÂç≥ÂèØÂà∑Êñ∞ ÁöÑÁä∂ÊÄÅ
          if (this.moveDistance > this.topDistance) {
            // ÂáèÂ∞ëËÆ°ÁÆóÂûãÂ±ûÊÄßÁöÑËÆ°ÁÆó
            if (this.topStatus !== "drop") {
              // ÈáäÊîæÂç≥ÂèØÂà∑Êñ∞
              this.topStatus = "drop";
              // ÊãñÊãΩËøáÁ®ã‰∏≠ ‰∏ÄÊó¶Êüê‰∏ÄÊ¨°ÊúâË∂ÖËøá‰∫Ü‰∏¥ÁïåÁÇπ
              this.lastRefreshTop = 60;
            }
          } else {
            // ÂáèÂ∞ëËÆ°ÁÆóÂûãÂ±ûÊÄßÁöÑËÆ°ÁÆó
            if (this.topStatus !== "pull") {
              // ‰∏ãÊãâÂç≥ÂèØÂà∑Êñ∞
              this.topStatus = "pull";
            }
          }
        }

        // Ê≠£Âú®Âà∑Êñ∞ ÂêéÈù¢Â∞±‰∏çÁî®Âå∫ÂàÜÁä∂ÊÄÅ‰∫Ü
        // if (this.refreshState === 2) {
        //   this.lastRefreshTop = 0;
        //   return;
        // } else {
        //   if (distance > this.topDistance) {
        //     this.lastRefreshTop = 60;
        //   }
        // }

        // console.log("++++ ‰∏ãÊãâËøáÁ®ã‰∏≠ ++++");
      }

      // Â¶ÇÊûúÊªöÂä®Êù°Â∑≤ÁªèÂú®È°∂ÈÉ®‰∫Ü„ÄÇÂ∞±Ê≤°ÂøÖË¶ÅÂÅö‰∏ãÊãâÂà∑Êñ∞‰∫Ü,‰∏î‰ºöËß¶Âèë onscroll ‰∫ã‰ª∂
      // ‰∏äÊãâ
      if (this.direction === "up") {
        // Ê£ÄÊµã‰∏äÊãâ‰∏¥ÁïåÁÇπ
        let upCriP =
          scrollEventTarget.scrollHeight - scrollEventTarget.clientHeight;
        // ËøôÈáåÈúÄË¶ÅÂÆπ‰∏™Èîô
        if (currentScrollTop === upCriP && this.startScrollTop !== upCriP) {
          // ËµãÂÄº
          this.startScrollTop = upCriP;
          // ÈáçÊñ∞ËÆæÁΩÆ startY
          this.startY = currentY;
          // distance ÂÄºËµãÂÄº‰∏∫0
          distance = 0;
          this.currentY = currentY;
        }
        // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææËøáÂ∫ïÈÉ®ÔºàPSÔºöÂæÆ‰ø°ÁöÑÈÄªËæëÔºöÂè™Ë¶Å‰∏äÊãâÂà∑Êñ∞Êéß‰ª∂ÂÆåÂÖ®ÊòæÁ§∫‰∫ÜÔºåÂ∞±ËÆ§‰∏∫ÂèØ‰ª•Âä†ËΩΩÊõ¥Â§öÔºâ
        this.bottomReached = this.checkBottomReached();
        if (this.bottomReached) {
          // ‰∏ªË¶ÅÊòØÈòªÊ≠¢ OnScroll‰∫ã‰ª∂
          e.preventDefault();
          e.stopPropagation();
          this.moveDistance = distance;
          // ÈòªÊ≠¢ÈªòËÆ§‰∫ã‰ª∂ÔºåÂú®ÂæÆ‰ø°ÊµèËßàÂô®‰∏≠Â∞§‰∏∫ÊúâÁî®ÔºåËá≥‰∫é‰∏∫‰ªÄ‰πàÔºå‰Ω†ÂéªËØïÂ∞±Áü•ÈÅì‰∫Ü„ÄÇ
        }
      }

      // console.log(
      //   "--- scrollTop " +
      //   scrollTop +
      //   " --- direction " +
      //   this.direction +
      //   " --- distance " +
      //   distance +
      //   " --- moveDistance " +
      //   this.moveDistance +
      //   " --- bottomReached " +
      //   this.bottomReached
      // );
    },
    // üî•Ê£ÄÊü•ÊòØÂê¶ÊªöÂä®Âà∞Â∫ïÈÉ®
    // - https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollHeight
    checkBottomReached() {
      let scrollEventTarget = document.getElementById("drag");
      let a = scrollEventTarget.scrollTop + scrollEventTarget.clientHeight;
      let b = scrollEventTarget.scrollHeight;
      return a >= b;
    },
    // ÁªìÊùüÊãñÊãΩ
    stopDrag() {
      let scrollTop = document.getElementById("drag").scrollTop;
      this.touchSate = 0;
      if (
        this.direction === "down" &&
        scrollTop === 0 &&
        this.topStatus !== "loading" &&
        this.moveDistance > 0
      ) {
        this.topDropped = true;
        if (this.topStatus === "drop") {
          this.topStatus = "loading";
          this.topMethod();
        } else {
          this.topStatus = "pull";
        }
      }

      // Âè™Ë¶ÅÂà∞Ëææ‰∫Ü‰∏äÊãâÊéß‰ª∂Âà∞Ëææ‰∫ÜÂ∫ïÈÉ®ÔºåÂ∞±ÁªôÊàëÂà∑Êñ∞
      if (
        this.direction === "up" &&
        this.bottomReached &&
        this.bottomStatus !== "loading" &&
        this.moveDistance < 0
      ) {
        this.bottomDropped = true;
        this.bottomReached = false;
        this.bottomStatus = "loading";
        // ‰∏äÊãâÂä†ËΩΩ‰∫ã‰ª∂
        this.bottomMethod();
      }

      // Ê∏ÖÁ©∫
      this.direction = "";
      // ÂæÆ‰ø°ÁªìÊùü‰∫ÜÊãñÊãΩÔºåÈÉΩÂæóÂΩí0Â§ÑÁêÜ
      this.moveDistance = 0;
      // ÁªìÊùüdrag
      this.lastRefreshTop = 0;
    },

    // ‰∏ÄÊó¶ scrollTop >0 Â∞±‰ºöËß¶Âèëonscroll
    onScroll(e) {
      // ÊªöÂä®Êù°‰ΩçÁΩÆ
      let scrollTop = e.target.scrollTop;
      // ËøôÈáåÂÅáËÆæ Âè™Ë¶ÅÈú≤Âá∫‰∏äÊãâÂä†ËΩΩÁöÑ 80%Â∞±ËÆ§‰∏∫ÂèØ‰ª•Âà∑Êñ∞
      let sh = e.target.scrollHeight - 50;
      let st = e.target.scrollTop + e.target.clientHeight;

      // console.log("+++ start +++");
      // console.log("sh === " + sh);
      // console.log("st === " + st);
      // console.log("touchState === " + this.touchSate);

      // ÂøÖÈ°ªÊòØtouchEndÁöÑÊÉÖÂÜµ‰∏ãÊúâÊïàÔºå‰∏î‰∏çÊòØÊ≠£Âú®‰∏ãÊãâÂà∑Êñ∞
      if (st >= sh && this.touchSate === 0 && this.bottomStatus !== "loading") {
        console.log("+++ OnScroll‰∏äÊãâÂä†ËΩΩ‰∫ã‰ª∂ +++");
        this.bottomStatus = "loading";
        // ‰∏äÊãâÂä†ËΩΩ‰∫ã‰ª∂
        this.bottomMethod();
      }

      // lastRefreshTop
      this.lastRefreshTop = scrollTop;
    },

    // ÂØºËà™Ê†èÊúâÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    cameraItemDidClick() {
      this.items = this.cameraItems;
      this.showCamera = true;
      this.showActionSheet = true;
    },
    // ÈÖçÁΩÆ actionsheet items
    configActionSheetItems() {
      const takePhoto = new ActionSheetItem({
        title: "ÊãçÊëÑ",
        subtitle: "ÁÖßÁâáÊàñËßÜÈ¢ë"
      });
      const album = new ActionSheetItem({
        title: "‰ªéÊâãÊú∫Áõ∏ÂÜåÈÄâÂèñ"
      });
      const del = new ActionSheetItem({
        title: "Âà†Èô§",
        destructive: true
      });
      const changeCover = new ActionSheetItem({
        title: "Êõ¥Êç¢Áõ∏ÂÜåÂ∞ÅÈù¢"
      });
      // ÂºïÁî®Êï∞ÁªÑ
      this.cameraItems = [takePhoto, album];
      this.delItems = [del];
      this.coverItems = [changeCover];
    },
    // actionSheet‰∫ã‰ª∂ÁÇπÂáª
    didClickItem(index) {
      console.log(index);
      if (index === 0) {
        // ÂèñÊ∂àÊåâÈíÆ
        this.items = [];
        this.showCamera = false;
        this.showDel = false;
        this.shwoCover = false;
        this.showPhoneNumber = false;
        this.showAvatar = false;
        this.actionSheetTitle = "";
        this.delCmtIndexPath = {};
        return;
      }
      // Â¶ÇÊûúÊòØÂºπÂá∫Âà†Èô§
      if (this.showDel) {
        this.showDel = false;
        // Ë∞ÉÁî®Âà†Èô§ËØÑËÆ∫‰∫ã‰ª∂
        this.deleteComment(this.delCmtIndexPath);
        this.delCmtIndexPath = {};
      }
      if (this.showPhoneNumber) {
        this.showPhoneNumber = false;
        this.actionSheetTitle = "";
      }
    },
    // Âà†Èô§ËØÑËÆ∫Êï∞ÊçÆ
    deleteComment(indexPath) {
      // Âà†Èô§Êï∞ÊçÆ ÂÆπÈîôÂ§ÑÁêÜ
      indexPath = indexPath || {};
      if (Object.keys(indexPath).length === 0) return;
      // ÂèñÂá∫moment
      const moment = this.moments[indexPath.section];
      // ÂèñÂá∫ËØÑËÆ∫Êï∞ÊçÆ
      const comment = moment.comments_list[indexPath.row];
      // ÂºÄÂßãÂà†Èô§
      moment.comments_list.some((cmt, i) => {
        if (cmt.idstr === comment.idstr) {
          moment.comments_list.splice(i, 1);
          return true;
        }
      });
    },
    // moment Êõ¥Â§öÊåâÈíÆ‰∫ã‰ª∂
    moreBtnAction(moment) {
      // ‰∏âÈÉ®Êõ≤
      if (Object.keys(this.tempMoment).length === 0) {
        moment.showCmt = true;
        this.tempMoment = moment;
      } else if (
        Object.keys(this.tempMoment).length !== 0 &&
        this.tempMoment === moment
      ) {
        moment.showCmt = !moment.showCmt;
      } else if (
        Object.keys(this.tempMoment).length !== 0 &&
        this.tempMoment !== moment
      ) {
        this.tempMoment.showCmt = false;
        moment.showCmt = true;
        this.tempMoment = moment;
      }
    },
    // ËøôÈáåÁõëÂê¨ÂÜíÊ≥°
    touchstartAction() {
      this.tempMoment.showCmt = false;
    },

    action() {
      console.log("----shhshshhs----");
    },

    // Ë∑≥ËΩ¨Âà∞Áî®Êà∑‰ø°ÊÅØ
    skipToContactInfo(moment) {
      let user = moment.user;
      // ÊâæÂà∞‰∫Ü,ÂàôË∑≥ËΩ¨Âà∞Áî®Êà∑‰ø°ÊÅØ
      this.$router.push({
        name: "contact-info",
        params: user
      });
    },
    // üëâüî•vueÂú®v-html‰∏≠ÁªëÂÆö‰∫ã‰ª∂
    // https://blog.csdn.net/fangdengfu123/article/details/84992278
    // https://blog.csdn.net/qq_25075279/article/details/84646782
    // https://blog.csdn.net/qq_31393401/article/details/81017912
    // ÁÇπËµûÂàóË°®Áî®Êà∑Ë¢´ÁÇπÂáª
    attitudesItemDidClick(section, event) {
      // ÁÇπÂáªhtml‰∏≠ÁöÑÊüê‰∏™span
      if (event.target.nodeName === "SPAN") {
        let dataKeyJson = event.target.getAttribute("data-key");
        let dataKeyObj = JSON.parse(dataKeyJson);
        // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáª‰∫ÜÁî®Êà∑
        if (dataKeyObj[helper.userInfoKey]) {
          let idstr = dataKeyObj[helper.userInfoKey];
          // ÊâæÂà∞Áî®Êà∑
          let moment = this.moments[section];
          // find
          moment.attitudes_list.some(item => {
            if (idstr === item.idstr) {
              // ÊâæÂà∞‰∫Ü,ÂàôË∑≥ËΩ¨Âà∞Áî®Êà∑‰ø°ÊÅØ
              this.$router.push({
                name: "contact-info",
                params: item
              });
              return true;
            }
          });
        }
      }
    },
    // ËØÑËÆ∫ÂàóË°®‰∏≠itemÁöÑÁÇπÂáª‰∫ã‰ª∂
    commentItemDidClick(section, row, event) {
      let moment = this.moments[section];
      let comment = moment.comments_list[row];

      if (event.target.nodeName === "DIV") {
        // ÂçïÁ∫ØÁöÑÁÇπÂáªÊüê‰∏™ËØÑËÆ∫ÂàóË°®
        // ÂèñÂá∫moment
        const moment = this.moments[section];
        // ÂèñÂá∫ËØÑËÆ∫Êï∞ÊçÆ
        const comment = moment.comments_list[row];
        if (comment.from_user.idstr === this.user.idstr) {
          // Ëá™Â∑±ÁöÑËØÑËÆ∫
          this.items = this.delItems;
          this.showDel = true;
          this.showActionSheet = true;
          this.delCmtIndexPath = {};
          // ËÆ∞ÂΩïË¶ÅÂà†Èô§ÁöÑËØÑËÆ∫Á¥¢Âºï
          this.delCmtIndexPath = {
            section: section,
            row: row
          };
        } else {
          // ÂõûÂ§ç/ËØÑËÆ∫
          // CMH TODO
        }
        return;
      }
      // ÁÇπÂáªv-html‰∏≠ÁöÑÊüê‰∏™span
      if (event.target.nodeName === "SPAN") {
        let dataKeyJson = event.target.getAttribute("data-key");
        let dataKeyObj = JSON.parse(dataKeyJson);
        // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáª‰∫ÜÁî®Êà∑
        if (dataKeyObj[helper.userInfoKey]) {
          let idstr = dataKeyObj[helper.userInfoKey];
          // ÊâæÂà∞Áî®Êà∑
          let user = {};
          if (comment.from_user.idstr === idstr) {
            user = comment.from_user;
          } else if (comment.to_user && comment.to_user.idstr === idstr) {
            user = comment.to_user;
          } else {
            // ËøôÁßçÊÉÖÂÜµÂ∞±ÊòØ ÁÇπÂáª @xxx ËøôÈáåÈöè‰æø‰º™ÈÄ†‰∏Ä‰∏™ ÂìàÂìà
            user.idstr = "89757";
            user.profile_image_url =
              "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1553016104583&di=45244cedc3d47c3c1fd7261869dc23da&imgtype=0&src=http%3A%2F%2Fimg1.touxiang.cn%2Fuploads%2F20140122%2F22-074744_465.jpg";
            user.screen_name = idstr;
          }
          // Ë∑≥ËΩ¨Âà∞Áî®Êà∑‰ø°ÊÅØ
          this.$router.push({
            name: "contact-info",
            params: user
          });
        }
        // Â∏∏ËßÑÂ§ÑÁêÜ
        this.handleContentOrCommentRichText(dataKeyObj);
      }
    },
    // ÂæÆ‰ø°Ê≠£ÊñáÁÇπÂáª‰∫ã‰ª∂
    contentDidClick(section, event) {
      // ÁÇπÂáªv-html‰∏≠ÁöÑÊüê‰∏™span
      if (event.target.nodeName === "SPAN") {
        let dataKeyJson = event.target.getAttribute("data-key");
        let dataKeyObj = JSON.parse(dataKeyJson);
        console.log(dataKeyObj);
        // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáª‰∫ÜÁî®Êà∑
        if (dataKeyObj[helper.userInfoKey]) {
          let idstr = dataKeyObj[helper.userInfoKey];
          // Ë∑≥ËΩ¨Âà∞Áî®Êà∑‰ø°ÊÅØ
          let user = {};
          // ËøôÁßçÊÉÖÂÜµÂ∞±ÊòØ ÁÇπÂáª @xxx ËøôÈáåÈöè‰æø‰º™ÈÄ†‰∏Ä‰∏™ ÂìàÂìà
          user.idstr = "89757";
          user.profile_image_url =
            "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1553016104583&di=45244cedc3d47c3c1fd7261869dc23da&imgtype=0&src=http%3A%2F%2Fimg1.touxiang.cn%2Fuploads%2F20140122%2F22-074744_465.jpg";
          user.screen_name = idstr;
          this.$router.push({
            name: "contact-info",
            params: user
          });
        }
        // Â∏∏ËßÑÂ§ÑÁêÜ
        this.handleContentOrCommentRichText(dataKeyObj);
      }
    },

    // Ê≠£Êñá+ËØÑËÆ∫ ÂØåÊñáÊú¨‰∫ã‰ª∂Â§ÑÁêÜ
    handleContentOrCommentRichText(dataKeyObj) {
      // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáª‰∫ÜÁîµËØùÂè∑Á†Å
      if (dataKeyObj[helper.phoneNumberKey]) {
        // ÂèñÂá∫ÁîµËØùÂè∑Á†Å
        let phoneNumber = dataKeyObj[helper.phoneNumberKey];
        // ÂºπÂá∫Ê°Ü
        this.actionSheetTitle = phoneNumber + "ÂèØËÉΩÊòØ‰∏Ä‰∏™ÁîµËØùÂè∑Á†ÅÔºå‰Ω†ÂèØ‰ª•";
        const call = new ActionSheetItem({
          title: "ÂëºÂè´"
        });
        const copy = new ActionSheetItem({
          title: "Â§çÂà∂Âè∑Á†Å"
        });
        const add = new ActionSheetItem({
          title: "Ê∑ªÂä†Âà∞ÊâãÊú∫ÈÄöËÆØÂΩï"
        });
        this.items = [call, copy, add];
        this.showActionSheet = true;
        this.showPhoneNumber = true;
      }

      // ÈìæÊé•/ËØùÈ¢ò
      if (dataKeyObj[helper.linkUrlKey] || dataKeyObj[helper.topicKey]) {
        let value =
          dataKeyObj[helper.linkUrlKey] || dataKeyObj[helper.topicKey];
        console.log(value);
        this.$router.push({
          name: "moments-other",
          params: {
            value: value
          }
        });
      }
    },

    // ÁÇπËµû
    thumbAction(moment, thumb) {
      moment.showCmt = false;
      moment.attitudes_status = thumb;
      moment.attitudes_list = moment.attitudes_list || [];
      // Êï∞ÊçÆÂ§ÑÁêÜ
      if (thumb === 0) {
        // ÂèñÊ∂àÁÇπËµû
        moment.attitudes_count -= 1;
        if (moment.attitudes_count < 0) moment.attitudes_count = 0;
        moment.attitudes_list.some((item, i) => {
          if (item.idstr === this.user.idstr) {
            // ‰ªéÊï∞ÁªÑ‰∏≠Âà†Èô§
            moment.attitudes_list.splice(i, 1);
            return true;
          }
        });
      } else {
        // ÁÇπËµû
        moment.attitudes_count += 1;
        moment.attitudes_list.push(this.user);
      }
      // Êï∞ÊçÆÂ§ÑÁêÜ
      if (moment.attitudes_list.length === 0) {
        // Ê≤°ÊúâÁÇπËµûÊï∞ÊçÆ
        moment.attitudesHtml = this.attitudesIcon;
      } else {
        // ÊãºÊé•Ë¶ÅÊê∫Â∏¶ÁöÑÊï∞ÊçÆ
        let userInfo = {};
        userInfo[helper.userInfoKey] = this.user.idstr;
        // ÂØπË±°ËΩ¨Â≠óÁ¨¶‰∏≤
        let dataKey = JSON.stringify(userInfo);
        // ÊúâÁÇπËµûÊï∞ÊçÆ
        if (thumb === 0) {
          // ÂèñÊ∂àÁÇπËµû
          // ÂÖàÊãºÊé•‰∏Ä‰∏™,
          moment.attitudesHtml = moment.attitudesHtml + ",";
          // Âà†Èô§
          let regExpStr =
            "&nbsp;&nbsp;" +
            "<span data-key=" +
            dataKey +
            ">" +
            this.user.screen_name +
            "</span>" +
            ",";
          let regExp = new RegExp(regExpStr);
          moment.attitudesHtml = moment.attitudesHtml.replace(regExp, "");
          // Âà†Èô§,
          moment.attitudesHtml = moment.attitudesHtml.substring(
            0,
            moment.attitudesHtml.length - 1
          );
        } else {
          // ÁÇπËµû
          if (moment.attitudes_list.length > 1) {
            moment.attitudesHtml = moment.attitudesHtml + ",";
          }
          // ÊãºÊé•Êï∞ÊçÆ
          moment.attitudesHtml =
            moment.attitudesHtml +
            "&nbsp;&nbsp;" +
            "<span data-key=" +
            dataKey +
            ">" +
            this.user.screen_name +
            "</span>";
        }
      }
    },
    // ËØÑËÆ∫
    commentAction(moment) {
      console.log(moment);
    },
    // Â∞ÅÈù¢Ë¢´ÁÇπÂáª
    coverDidClick() {
      this.items = this.coverItems;
      this.shwoCover = true;
      this.showActionSheet = true;
    },

    // ‰∏ãÊãâÂà∑Êñ∞‰∫ã‰ª∂
    topMethod() {
      setTimeout(() => {
        this.topStatus = "";
        this.moveDistance = 0;
      }, 5000);
    },
    // ‰∏äÊãâÂä†ËΩΩ‰∫ã‰ª∂
    bottomMethod() {
      let page = this.page + 1;
      // Ê®°Êãü‰∏Ä‰∏ãÁΩëÁªúËØ∑Ê±ÇÊï∞ÊçÆ
      setTimeout(() => {
        console.log("++++ ‰∏äÊãâÂä†ËΩΩ‰∫ã‰ª∂ ++++ " + page);
        this.page = page;
        this.bottomStatus = "";
        // ËÆ∞ÂΩï‰∏Ä‰∏Ä‰∏ãËµ∑ÂßãÁ¥¢Âºï
        let start = this.moments.length;
        // Êï∞ÊçÆÊõ¥Êñ∞
        let temps = [];
        if (page === 2) {
          temps = this.handleWebDatas(MHMoments2.moments);
        } else if (page === 3) {
          temps = this.handleWebDatas(MHMoments3.moments);
        } else if (page === 4) {
          temps = this.handleWebDatas(MHMoments4.moments);
        }
        this.moments.push(...temps);
        // domÊõ¥Êñ∞
        this.$nextTick(() => {
          this.handleDomDatas(start);
        });
      }, 2500);
    },

    // Êï∞ÊçÆwebÂ§ÑÁêÜ
    handleWebDatas(ms) {
      return helper.handleWebDatas(ms);
    },

    // Â§ÑÁêÜdomÊï∞ÊçÆ start Ëµ∑ÂßãÁ¥¢Âºï
    handleDomDatas(start) {
      if (this.$refs.content === undefined) return;
      // Ëé∑ÂèñDOMÂÖÉÁ¥†ÂàóË°®
      this.$refs.content;
      let length = this.$refs.content.length;
      for (let i = start; i < length; i++) {
        // ÂèñÂá∫ÂÖÉÁ¥†
        const element = this.$refs.content[i];
        // ÂèñÂá∫Êï∞ÊçÆ
        const moment = this.moments[i];
        // Ëé∑ÂèñÊñáÊú¨ÂÜÖÂÆπÈ´òÂ∫¶
        let contentH = window
          .getComputedStyle(element)
          .height.replace("px", "");
        // Âà§Êñ≠
        if (contentH > 5 * 24) {
          moment.unfold = false;
          moment.showUnfold = true;
        } else {
          moment.unfold = true;
          moment.showUnfold = false;
        }
      }
    }
  },
  // ÂÆö‰πâ‰∏Ä‰∏™ËøáÊª§Âô®
  filters: {
    // üëâ üî• JSÂ∞ÜÊó∂Èó¥Êà≥ËΩ¨Êç¢
    // - [JSÂ∞ÜÊó∂Èó¥Êà≥ËΩ¨Êç¢‰∏∫ÂàöÂàö„ÄÅNÂàÜÈíüÂâç„ÄÅ‰ªäÂ§©Âá†ÁÇπÂá†ÂàÜ„ÄÅÊò®Â§©Âá†ÁÇπÂá†ÂàÜÁ≠âË°®Á§∫Ê≥ï](https://www.cnblogs.com/taochengyong/p/9341986.html)
    // ÊúãÂèãÂúàÊó∂Èó¥Ê†ºÂºèÂåñ
    dateFormat(srcDate) {
      return helper.dateFormat(srcDate);
    }
  },
  computed: {
    //
    transform() {
      return { transform: `translate3d(0,${this.moveDistance}px, 0)` };
    },

    // Âà∑Êñ∞ballÊ†∑ÂºèÂ§ÑÁêÜ
    refreshStyle() {
      // ÊéßÂà∂Âà∑Êñ∞Â∞èÁêÉÁöÑÁä∂ÊÄÅ
      var cy = this.moveDistance;
      let opacity = cy > this.topDistance ? 1 : 0;
      let top = -30;
      let transform = "";
      let duration = "0.2s";
      let property = "";
      // Ê≠£Âú®Âà∑Êñ∞
      if (this.topStatus === "loading") {
        // Ê≠£Âú®Âà∑Êñ∞ÁöÑËøáÁ®ã‰∏≠ÔºåÂ∞èÁêÉÂèØ‰ª•Ê†πÊçÆÈ°µÈù¢ÊªöÂä®ËÄåÊªöÂä®
        top = Math.max(-30, 60 - this.lastRefreshTop);
        opacity = 1;
        transform = "";
      } else {
        // Ê≠£Âú®touchmove, Âè™ÊéßÂà∂ÊòæÁ§∫orÈöêËóèÔºå‰∏çÂÅötopÂ§ÑÁêÜ
        if (this.touchSate === 2) {
          top = cy > this.topDistance ? 60 : this.lastRefreshTop;
          transform = "rotate(" + -cy * 3 + "deg)";
          property = "top,opacity";
        } else if (this.touchSate === 0) {
          property = "top,opacity";
        }
      }
      // ËøîÂõûÊ†∑Âºè
      return {
        top: top + "px",
        transitionDuration: duration,
        transitionProperty: property,
        opacity: opacity,
        transform: transform
      };
    },

    ...mapState({
      // ÂΩìÂâçÁî®Êà∑
      user: state => state.user
    })
  },
  watch: {},
  components: {
    actionSheet,
    MomentOperationMore,
    MomentProfile
  }
};
</script>

<style src="./css/moments.css" scoped>
/* üî• Vue styleÈáåÈù¢‰ΩøÁî®scopedÂ±ûÊÄßÂπ∂@importÂºïÂÖ•Â§ñÈÉ®css, ‰ΩúÁî®ÂüüÊòØÂÖ®Â±ÄÁöÑËß£ÂÜ≥ÊñπÊ°à */
/* - [Vue styleÈáåÈù¢‰ΩøÁî®@importÂºïÂÖ•Â§ñÈÉ®css, ‰ΩúÁî®ÂüüÊòØÂÖ®Â±ÄÁöÑËß£ÂÜ≥ÊñπÊ°à](https://www.cnblogs.com/ajaxlu/p/9086651.html) */
/* - [Vue styleÈáåÈù¢‰ΩøÁî®scopedÂ±ûÊÄßÂπ∂@importÂºïÂÖ•Â§ñÈÉ®css, ‰ΩúÁî®ÂüüÊòØÂÖ®Â±ÄÁöÑËß£ÂÜ≥ÊñπÊ°à](https://blog.csdn.net/weixin_39941429/article/details/80254724) */
/* @import "./css/moments.css"; */
</style>
